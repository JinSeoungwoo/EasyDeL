
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Erfan Zare Chavoshi">
      
      
      
        <link rel="prev" href="../lib-python-EasyDel-rlhf-utils/">
      
      
        <link rel="next" href="../lib-python-EasyDel-trainer-config/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>fsdp_train - EasyDel</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fad675c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#trainerfsdp_train" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="EasyDel" class="md-header__button md-logo" aria-label="EasyDel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EasyDel
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              fsdp_train
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/erfanzar/EasyDel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EasyDel" class="md-nav__button md-logo" aria-label="EasyDel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EasyDel
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/erfanzar/EasyDel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../AvailableModels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AvailableModels
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EasyBIT
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Eval
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Eval
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-eval-lm_eval/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lm_eval
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Transform
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Transform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-transform-easydel_transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    easydel_transform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-transform-mpt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mpt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-transform-llama/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    llama
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-transform-falcon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    falcon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-transform-mistral/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mistral
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-transform-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-smi-smi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smi
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Serve
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Serve
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-serve-torch_serve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch_serve
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-serve-jax_serve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jax_serve
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-serve-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-falcon-modelling_falcon_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Falcon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-palm-modelling_palm_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Palm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-flax_modelling_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    flax_modelling_utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-gpt_neo_x-modelling_gpt_neo_x_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPT-Neox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-gpt_j-modelling_gpt_j_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPT-J
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-mistral-modelling_mistral_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mistral
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-auto_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    auto_models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-lucid_transformer-modelling_lt_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LucidTransformers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-opt-modelling_opt_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OPT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-mosaic_mpt-modelling_mpt_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MPT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-llama-modelling_llama_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llama
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-modules-t5-modelling_t5_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    T5
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-configs-configs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    configs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-utils-tensor_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tensor_utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-utils-prompters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    prompters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-utils-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-utils-checker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    checker
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    RLHF
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            RLHF
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-rlhf-trainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    trainer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-rlhf-reward/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    reward
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-rlhf-ppo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-rlhf-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" checked>
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Trainer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Trainer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    fsdp_train
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    fsdp_train
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train" class="md-nav__link">
    <span class="md-ellipsis">
      fsdp_train
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      CausalLMTrainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CausalLMTrainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      configure_dataloader()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_functions" class="md-nav__link">
    <span class="md-ellipsis">
      configure_functions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_model" class="md-nav__link">
    <span class="md-ellipsis">
      configure_model()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.finish" class="md-nav__link">
    <span class="md-ellipsis">
      finish()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.init_functions" class="md-nav__link">
    <span class="md-ellipsis">
      init_functions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.train" class="md-nav__link">
    <span class="md-ellipsis">
      train()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.calculate_accuracy" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_accuracy()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.create_fsdp_eval_step" class="md-nav__link">
    <span class="md-ellipsis">
      create_fsdp_eval_step()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.create_fsdp_train_step" class="md-nav__link">
    <span class="md-ellipsis">
      create_fsdp_train_step()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-trainer-config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-trainer-tf_dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tf_dataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-trainer-training_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    training_utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linen
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Linen
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-linen-bits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-linen-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    RL Trainer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            RL Trainer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-rl_trainer-models-modelling_base.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    models/modelling_base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-rl_trainer-models-modelling_value_head.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    models/modelling_value_head
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-rl_trainer-core.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    core
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data Preprocessing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            Data Preprocessing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lib-python-EasyDel-data_preprocessing-_processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data_preprocessing/_processor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
        
          
          <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_17">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PyTorchServer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PytorchServer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../JAXServer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JAXServer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DataProcessing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DataProcessing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../TrainingExample/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TrainingExample
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Falcon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Falcon Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Llama/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llama Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Llama2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llama2 Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Mistral/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mistral Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../MosaicMPT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MosaicMPT Models
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train" class="md-nav__link">
    <span class="md-ellipsis">
      fsdp_train
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      CausalLMTrainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CausalLMTrainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      configure_dataloader()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_functions" class="md-nav__link">
    <span class="md-ellipsis">
      configure_functions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_model" class="md-nav__link">
    <span class="md-ellipsis">
      configure_model()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.finish" class="md-nav__link">
    <span class="md-ellipsis">
      finish()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.init_functions" class="md-nav__link">
    <span class="md-ellipsis">
      init_functions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.train" class="md-nav__link">
    <span class="md-ellipsis">
      train()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.calculate_accuracy" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_accuracy()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.create_fsdp_eval_step" class="md-nav__link">
    <span class="md-ellipsis">
      create_fsdp_eval_step()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.create_fsdp_train_step" class="md-nav__link">
    <span class="md-ellipsis">
      create_fsdp_train_step()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.trainer.fsdp_train.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="trainerfsdp_train">trainer.fsdp_train</h1>


<div class="doc doc-object doc-module">



<a id="lib.python.EasyDel.trainer.fsdp_train"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer" class="doc doc-heading">
          <code>CausalLMTrainer</code>


</h2>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CausalLMTrainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">arguments</span><span class="p">:</span> <span class="n">TrainArguments</span><span class="p">,</span>
                 <span class="n">dataset_train</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
                 <span class="n">dataset_eval</span><span class="p">:</span> <span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">finetune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">ckpt_path</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">_do_init_fns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The __init__ function is called when the class is instantiated.</span>
<span class="sd">        It sets up all the variables that are needed for training, including:</span>
<span class="sd">        - The timer to keep track of how long each epoch takes.</span>
<span class="sd">        - The dataloaders for both training and evaluation (if provided).</span>
<span class="sd">        - The model itself, which will be created from a checkpoint if one was provided.  Otherwise,</span>
<span class="sd">         it will be created from scratch using the arguments passed in by the user.</span>
<span class="sd">         Note that this function also handles creating a mesh if one was not already specified in arguments</span>
<span class="sd">         or loaded from a checkpoint file (see below).   This means that you can pass in either</span>

<span class="sd">        :param self: Represent the instance of the class</span>
<span class="sd">        :param arguments: TrainArguments: Pass the arguments to the trainer</span>
<span class="sd">        :param dataset_train: Dataset: Pass the training dataset to the trainer</span>
<span class="sd">        :param dataset_eval: Dataset: Pass the validation dataset</span>
<span class="sd">        :param finetune: bool: Load the model from a checkpoint</span>
<span class="sd">        :param ckpt_path: typing.Union[str,os.PathLike] : Load the checkpoint path</span>
<span class="sd">        :param _do_init_fns: bool: Initialize the functions</span>
<span class="sd">        :return: Nothing, it just initializes the class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_train</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_eval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_eval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharded_create_from_params_fn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharded_train_step_fn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharded_predict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_fn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_state_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_state_partition_spec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_train</span> <span class="o">=</span> <span class="n">dataset_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span> <span class="o">=</span> <span class="n">dataset_eval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finetune</span> <span class="o">=</span> <span class="n">finetune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">ckpt_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_dtype</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">param_dtype</span>
        <span class="k">if</span> <span class="n">finetune</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ckpt_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prefix_print</span><span class="p">(</span>
                    <span class="s1">&#39;Warning&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;In case of using finetune = True and Passing ckpt_path = None you should pass parameters&#39;</span>
                    <span class="s1">&#39;in train function&#39;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">_do_init_fns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_functions</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix_print</span><span class="p">(</span><span class="s1">&#39;Warning&#39;</span><span class="p">,</span> <span class="s1">&#39;you have set _do_init_fns to False so function will not me initialized you have &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;to do in manually (simply with  trainer.init_functions() )&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CausalLMTrainer(&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">string_func</span><span class="p">(</span><span class="n">it_self</span><span class="p">):</span>

                    <span class="n">string_</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">it_self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">k_</span><span class="p">,</span> <span class="n">v_</span> <span class="ow">in</span> <span class="n">it_self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">string_</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k_</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">v_</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">string_</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">)&#39;</span>
                    <span class="k">return</span> <span class="n">string_</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">.</span><span class="fm">__str__</span> <span class="o">=</span> <span class="n">string_func</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">string</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">finish</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The finish function is called when the experiment ends.</span>
<span class="sd">        It can be used to save data, upload files, or do any other cleanup tasks.</span>

<span class="sd">        :return: A dictionary of the run&#39;s metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The init_functions function is responsible for initializing the following:</span>
<span class="sd">            - wandb_runtime (if you use_wandb is True)</span>
<span class="sd">            - timer object (for logging time taken by various functions)</span>
<span class="sd">            - dataloader objects for training and evaluation data, along with max steps per epoch.</span>
<span class="sd">              The configure_dataloader function accomplishes this task.</span>

<span class="sd">        :param self: Represent the instance of the class</span>
<span class="sd">        :return: A tuple of functions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_wandb_init</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">Timers</span><span class="p">(</span>
            <span class="n">use_wandb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">tensorboard_writer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_board</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
            <span class="s1">&#39;configure dataloaders&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_eval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_dataloader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
            <span class="s1">&#39;configure dataloaders&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="s1">&#39;configure dataloaders&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
            <span class="s1">&#39;configure Model ,Optimizer ,Scheduler and Config&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
            <span class="s1">&#39;configure Model ,Optimizer ,Scheduler and Config&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="s1">&#39;configure Model ,Optimizer ,Scheduler and Config&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
            <span class="s1">&#39;configure functions and sharding them&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_functions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharded_create_from_params_fn</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharded_train_step_fn</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharded_predict</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_fn</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
            <span class="s1">&#39;configure functions and sharding them&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="s1">&#39;configure functions and sharding them&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">configure_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The configure_dataloader function is used to configure the dataloader for training and evaluation.</span>

<span class="sd">        :param self: Refer to the class instance itself</span>
<span class="sd">        :return: A dataloader_train, max_steps_train, dataloader_eval and max steps eval</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">is_left_padded</span><span class="p">:</span>
                    <span class="n">ssp</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_length</span><span class="p">:]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ssp</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="n">rs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ssp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ssp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">rs</span>

        <span class="n">dataloader_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_train</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
                                      <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">total_batch_size</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_steps_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">dataloader_train</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_eval</span><span class="p">:</span>
            <span class="n">dataloader_eval</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
                                         <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">total_batch_size</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">max_steps_eval</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">dataloader_eval</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataloader_eval</span><span class="p">,</span> <span class="n">max_steps_eval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">dataloader_train</span><span class="p">,</span> <span class="n">max_steps_train</span><span class="p">,</span> <span class="n">dataloader_eval</span><span class="p">,</span> <span class="n">max_steps_eval</span>

    <span class="k">def</span> <span class="nf">configure_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The configure_model function is responsible for creating the model, optimizer and scheduler.</span>

<span class="sd">        :param self: Represent the instance of the class</span>
<span class="sd">        :return: A model, optimizer, scheduler and config</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_configs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">extra_configs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">extra_configs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span>
                                                <span class="p">,</span> <span class="n">gradient_checkpointing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">gradient_checkpointing</span><span class="p">,</span>
                                                <span class="n">use_pjit_attention_force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_pjit_attention_force</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">extra_configs</span>
                                                <span class="p">)</span>

            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;get_partition_rules&#39;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">FlaxAutoModelForCausalLM</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                         <span class="n">param_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">param_dtype</span><span class="p">,</span>
                                                         <span class="n">_do_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">],</span> <span class="s1">&#39;get_partition_rules&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">custom_rule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;if you are using custom model to init you must&#39;</span> \
                                                               <span class="s1">&#39; pass custom_rule for partition rules &#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span>
                <span class="s1">&#39;config&#39;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">use_pjit_attention_force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_pjit_attention_force</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">sharding_array</span>

            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_class</span><span class="p">(</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">,</span>
                <span class="n">_do_init</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>

        <span class="n">tx</span><span class="p">,</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_optimizer_and_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">configure_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The configure_functions function is responsible for configuring the functions that will be used in training.</span>
<span class="sd">        It does this by first defining a function called init_fn, which initializes the model parameters and returns them as a</span>
<span class="sd">        TrainState object. The TrainState object contains all of the information needed to train or evaluate on a batch of data,</span>
<span class="sd">        including:</span>

<span class="sd">        :param self: Access the class attributes</span>
<span class="sd">        :return: A tuple of functions</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">init_fn</span><span class="p">():</span>
            <span class="n">params__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">init_weights</span><span class="p">(</span>
                <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">init_input_shape</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">:</span>
                <span class="n">params__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to_bf16</span><span class="p">(</span><span class="n">params__</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span><span class="p">:</span>
                <span class="n">params__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">(</span><span class="n">params__</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">freeze</span><span class="p">({</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params__</span><span class="p">}),</span>
                <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__call__</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">create_train_state_from_params</span><span class="p">(</span><span class="n">params_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span>
                <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params_</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">loss_remat</span> <span class="o">==</span> <span class="s1">&#39;OHA&#39;</span><span class="p">:</span>
            <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">fjformer</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">loss_func</span><span class="o">.</span><span class="n">cross_entropy_with_logits</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">loss_remat</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">fused_cross_entropy_loss_and_accuracy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">cross_entropy_loss_and_accuracy</span>

        <span class="k">def</span> <span class="nf">fsdp_train_step_</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">with_sharding_constraint</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">step_partition_spec</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">batch</span><span class="p">,</span>
                                        <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

                <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span>
                    <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:]</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span>

            <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">calculate_loss</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">(</span><span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span><span class="p">),</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="o">=</span><span class="n">grad</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span>

        <span class="n">train_state_shape</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">eval_shape</span><span class="p">(</span><span class="n">init_fn</span><span class="p">)</span>
        <span class="n">train_state_partition_spec</span> <span class="o">=</span> <span class="n">match_partition_rules</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_partition_rules</span><span class="p">(</span>
                <span class="n">fully_fsdp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">fully_fsdp</span>
            <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">custom_rule</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">custom_rule</span><span class="p">,</span>
            <span class="n">train_state_shape</span>
        <span class="p">)</span>
        <span class="n">sharded_create_from_params_fn</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
            <span class="n">create_train_state_from_params</span><span class="p">,</span>
            <span class="n">in_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="o">.</span><span class="n">params</span><span class="p">,),</span>
            <span class="n">out_shardings</span><span class="o">=</span><span class="n">train_state_partition_spec</span><span class="p">,</span>
            <span class="n">donate_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="n">sharded_train_step_fn</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
            <span class="n">fsdp_train_step_</span><span class="p">,</span>
            <span class="n">in_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">()),</span>
            <span class="n">out_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">(),</span> <span class="n">PartitionSpec</span><span class="p">()),</span>
            <span class="n">donate_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">sharded_predict</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="n">out_shardings</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(),</span>
                               <span class="n">in_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">()))</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_mesh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">ckpt_path_exists</span><span class="p">()</span>
        <span class="n">ckpt_streamer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_streaming_checkpointer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_state_partition_spec</span> <span class="o">=</span> <span class="n">train_state_partition_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_state_shape</span> <span class="o">=</span> <span class="n">train_state_shape</span>
        <span class="k">return</span> <span class="n">sharded_create_from_params_fn</span><span class="p">,</span> <span class="n">sharded_train_step_fn</span><span class="p">,</span> <span class="n">sharded_predict</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ckpt_streamer</span><span class="p">,</span> <span class="n">init_fn</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_parameters</span><span class="p">:</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FrozenDict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputFineTuner</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The train function is the main function of this module.</span>
<span class="sd">        It takes a model_parameters argument which can be used to load a pretrained model and finetune it.</span>
<span class="sd">        The train function returns an OutputFineTuner object that contains the last saved file name, predict func,</span>
<span class="sd">        train state, mesh and checkpoint streamer.</span>


<span class="sd">        :param self: Make the class methods aware of other methods and attributes within the class</span>
<span class="sd">        :param model_parameters: flax.core.FrozenDict: Load a pre-trained model</span>
<span class="sd">        :return: An object of type &quot;OutputFineTuner&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">count_params</span><span class="p">(</span><span class="n">_p</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31mModel Contain : &#39;</span><span class="p">,</span>
                  <span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_flatten</span><span class="p">(</span><span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">_p</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
                  <span class="s1">&#39; Billion Parameters&#39;</span><span class="p">)</span>

        <span class="n">dir_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;/dev/shm&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">track_memory</span><span class="p">:</span>
            <span class="n">initialise_tracking</span><span class="p">(</span><span class="n">dir_prefix</span><span class="o">=</span><span class="n">dir_prefix</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finetune</span><span class="p">:</span>
                <span class="n">shard_fns</span><span class="p">,</span> <span class="n">gather_fns</span> <span class="o">=</span> <span class="n">make_shard_and_gather_fns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_state_partition_spec</span><span class="p">,</span>
                                                                  <span class="n">dtype_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">model_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">prefix_print</span><span class="p">(</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Loading Model From </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">StreamingCheckpointer</span><span class="o">.</span><span class="n">load_trainstate_checkpoint</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;params::</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_state_shape</span><span class="p">,</span> <span class="n">shard_fns</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">remove_ckpt_after_load</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prefix_print</span><span class="p">(</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Sharding Passed Parameters&#39;</span>
                    <span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">flax.core</span> <span class="kn">import</span> <span class="n">unfreeze</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_parameters</span><span class="p">,</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FrozenDict</span><span class="p">):</span>
                        <span class="n">prefix_print</span><span class="p">(</span>
                            <span class="s1">&#39;Warning&#39;</span><span class="p">,</span> <span class="s1">&#39;Model Parameters should be like FrozenDict({&quot;params&quot; : params}) make sure to &#39;</span>
                                       <span class="s1">&#39;pass as type FrozenDict in case of not getting UnExcepted Errors &#39;</span>
                        <span class="p">)</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">model_parameters</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_shard_fns</span> <span class="k">else</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shard_fns</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                        <span class="n">model_parameters</span><span class="p">)</span>

                <span class="n">sharded_train_state_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharded_create_from_params_fn</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

                <span class="n">count_params</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sharded_train_state_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_fn</span><span class="p">()</span>

                <span class="n">count_params</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">learning_rates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;model billion parameters&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="n">i</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                            <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_flatten</span><span class="p">(</span><span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e9</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_train</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">:</span>

                            <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>

                            <span class="k">for</span> <span class="n">ssb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">ids_to_pop_from_dataset</span><span class="p">:</span>
                                <span class="n">_</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ssb</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">time_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">sharded_train_state_</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharded_train_step_fn</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="p">,</span>
                                                                                              <span class="n">batch</span>
                                                                                              <span class="p">)</span>
                            <span class="n">ttl_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_s</span>
                            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                            <span class="n">learning_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                            <span class="n">accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">track_memory</span><span class="p">:</span>
                                <span class="n">mem_res</span> <span class="o">=</span> <span class="n">get_mem</span><span class="p">(</span><span class="n">dir_prefix</span><span class="o">=</span><span class="n">dir_prefix</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">mem_res</span> <span class="o">=</span> <span class="s1">&#39;Tracking Option is OFF&#39;</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span><span class="p">:</span>
                                <span class="k">with</span> <span class="n">jax</span><span class="o">.</span><span class="n">spmd_mode</span><span class="p">(</span><span class="s2">&quot;allow_all&quot;</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                        <span class="p">{</span>
                                            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span>
                                                <span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                            <span class="s2">&quot;step time&quot;</span><span class="p">:</span> <span class="n">ttl_time</span><span class="p">,</span>
                                            <span class="s2">&quot;perplexity&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                            <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                            <span class="s2">&quot;avg_accuracy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">accuracies</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accuracies</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                            <span class="s2">&quot;mem_res&quot;</span><span class="p">:</span> <span class="n">mem_res</span><span class="p">,</span>
                                        <span class="p">}</span>
                                    <span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">track_memory</span><span class="p">:</span>
                                <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">pbar</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">mem_res</span><span class="p">)</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
                                             <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                             <span class="n">step</span><span class="o">=</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                             <span class="n">perplexity</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                             <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span>
                                             <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">save_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Model to </span><span class="se">\033</span><span class="s1">[1;30m</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\033</span><span class="s1">[1;0m&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
                                                               <span class="n">filename</span><span class="p">,</span>
                                                               <span class="n">gather_fns</span><span class="o">=</span><span class="n">gather_fns</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;30m KeyboardInterrupt At training model Will return current state of the model * </span><span class="se">\033</span><span class="s1">[1;0m&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_eval</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pbar_eval</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_steps_eval</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_eval</span><span class="p">,</span> <span class="n">batch_eval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader_eval</span><span class="p">):</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">batch_eval</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;token_type_ids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">batch_eval</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_eval</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">ids_to_pop_from_dataset</span><span class="p">:</span>
                            <span class="n">_</span> <span class="o">=</span> <span class="n">batch_eval</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">loss_eval</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">create_fsdp_eval_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">step_partition_spec</span><span class="p">)(</span>
                            <span class="n">sharded_train_state_</span><span class="p">,</span> <span class="n">batch_eval</span><span class="p">)</span>
                        <span class="n">pbar_eval</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;loss_eval&#39;</span><span class="p">:</span> <span class="n">loss_eval</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                 <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
                            <span class="p">)</span>
                        <span class="n">pbar_eval</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss_eval</span><span class="o">=</span><span class="n">loss_eval</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">save_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_last_save</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Model to </span><span class="se">\033</span><span class="s1">[1;30m</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\033</span><span class="s1">[1;0m&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
                                                   <span class="n">filename</span><span class="p">,</span>
                                                   <span class="n">gather_fns</span><span class="o">=</span><span class="n">gather_fns</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;not_saved | None&#39;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">OutputFineTuner</span><span class="p">(</span>
            <span class="n">last_save_file_name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">predict_fun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sharded_predict</span><span class="p">,</span>
            <span class="n">train_state</span><span class="o">=</span><span class="n">sharded_train_state_</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
            <span class="n">shard_fns</span><span class="o">=</span><span class="n">shard_fns</span><span class="p">,</span>
            <span class="n">gather_fns</span><span class="o">=</span><span class="n">gather_fns</span><span class="p">,</span>
            <span class="n">ckpt_stream</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span>
        <span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">dataset_train</span><span class="p">,</span> <span class="n">dataset_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">finetune</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_do_init_fns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The <strong>init</strong> function is called when the class is instantiated.
It sets up all the variables that are needed for training, including:
- The timer to keep track of how long each epoch takes.
- The dataloaders for both training and evaluation (if provided).
- The model itself, which will be created from a checkpoint if one was provided.  Otherwise,
 it will be created from scratch using the arguments passed in by the user.
 Note that this function also handles creating a mesh if one was not already specified in arguments
 or loaded from a checkpoint file (see below).   This means that you can pass in either</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Represent the instance of the class</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>arguments</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="lib.python.EasyDel.trainer.config.TrainArguments" href="../lib-python-EasyDel-trainer-config/#lib.python.EasyDel.trainer.config.TrainArguments">TrainArguments</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>TrainArguments: Pass the arguments to the trainer</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dataset_train</code></td>
          <td>
                <code><span title="datasets.Dataset">Dataset</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dataset: Pass the training dataset to the trainer</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dataset_eval</code></td>
          <td>
                <code><span title="datasets.Dataset">Dataset</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dataset: Pass the validation dataset</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>finetune</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>bool: Load the model from a checkpoint</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>ckpt_path</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, <span title="os.PathLike">PathLike</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>typing.Union[str,os.PathLike] : Load the checkpoint path</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>_do_init_fns</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>bool: Initialize the functions</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Nothing, it just initializes the class</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">arguments</span><span class="p">:</span> <span class="n">TrainArguments</span><span class="p">,</span>
             <span class="n">dataset_train</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
             <span class="n">dataset_eval</span><span class="p">:</span> <span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">finetune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">ckpt_path</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">_do_init_fns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
             <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The __init__ function is called when the class is instantiated.</span>
<span class="sd">    It sets up all the variables that are needed for training, including:</span>
<span class="sd">    - The timer to keep track of how long each epoch takes.</span>
<span class="sd">    - The dataloaders for both training and evaluation (if provided).</span>
<span class="sd">    - The model itself, which will be created from a checkpoint if one was provided.  Otherwise,</span>
<span class="sd">     it will be created from scratch using the arguments passed in by the user.</span>
<span class="sd">     Note that this function also handles creating a mesh if one was not already specified in arguments</span>
<span class="sd">     or loaded from a checkpoint file (see below).   This means that you can pass in either</span>

<span class="sd">    :param self: Represent the instance of the class</span>
<span class="sd">    :param arguments: TrainArguments: Pass the arguments to the trainer</span>
<span class="sd">    :param dataset_train: Dataset: Pass the training dataset to the trainer</span>
<span class="sd">    :param dataset_eval: Dataset: Pass the validation dataset</span>
<span class="sd">    :param finetune: bool: Load the model from a checkpoint</span>
<span class="sd">    :param ckpt_path: typing.Union[str,os.PathLike] : Load the checkpoint path</span>
<span class="sd">    :param _do_init_fns: bool: Initialize the functions</span>
<span class="sd">    :return: Nothing, it just initializes the class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_train</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_eval</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_eval</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sharded_create_from_params_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sharded_train_step_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sharded_predict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_state_shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_state_partition_spec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_train</span> <span class="o">=</span> <span class="n">dataset_train</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span> <span class="o">=</span> <span class="n">dataset_eval</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">finetune</span> <span class="o">=</span> <span class="n">finetune</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">ckpt_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_dtype</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">param_dtype</span>
    <span class="k">if</span> <span class="n">finetune</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ckpt_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix_print</span><span class="p">(</span>
                <span class="s1">&#39;Warning&#39;</span><span class="p">,</span>
                <span class="s1">&#39;In case of using finetune = True and Passing ckpt_path = None you should pass parameters&#39;</span>
                <span class="s1">&#39;in train function&#39;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">_do_init_fns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_functions</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix_print</span><span class="p">(</span><span class="s1">&#39;Warning&#39;</span><span class="p">,</span> <span class="s1">&#39;you have set _do_init_fns to False so function will not me initialized you have &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;to do in manually (simply with  trainer.init_functions() )&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_dataloader" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">configure_dataloader</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The configure_dataloader function is used to configure the dataloader for training and evaluation.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Refer to the class instance itself</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dataloader_train, max_steps_train, dataloader_eval and max steps eval</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">configure_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The configure_dataloader function is used to configure the dataloader for training and evaluation.</span>

<span class="sd">    :param self: Refer to the class instance itself</span>
<span class="sd">    :return: A dataloader_train, max_steps_train, dataloader_eval and max steps eval</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">is_left_padded</span><span class="p">:</span>
                <span class="n">ssp</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_length</span><span class="p">:]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ssp</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="n">rs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ssp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ssp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rs</span>

    <span class="n">dataloader_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_train</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">total_batch_size</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">max_steps_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">dataloader_train</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_eval</span><span class="p">:</span>
        <span class="n">dataloader_eval</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">total_batch_size</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_steps_eval</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">dataloader_eval</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">max_steps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataloader_eval</span><span class="p">,</span> <span class="n">max_steps_eval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">dataloader_train</span><span class="p">,</span> <span class="n">max_steps_train</span><span class="p">,</span> <span class="n">dataloader_eval</span><span class="p">,</span> <span class="n">max_steps_eval</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_functions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">configure_functions</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The configure_functions function is responsible for configuring the functions that will be used in training.
It does this by first defining a function called init_fn, which initializes the model parameters and returns them as a
TrainState object. The TrainState object contains all of the information needed to train or evaluate on a batch of data,
including:</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Access the class attributes</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of functions</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">configure_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The configure_functions function is responsible for configuring the functions that will be used in training.</span>
<span class="sd">    It does this by first defining a function called init_fn, which initializes the model parameters and returns them as a</span>
<span class="sd">    TrainState object. The TrainState object contains all of the information needed to train or evaluate on a batch of data,</span>
<span class="sd">    including:</span>

<span class="sd">    :param self: Access the class attributes</span>
<span class="sd">    :return: A tuple of functions</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">init_fn</span><span class="p">():</span>
        <span class="n">params__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">init_weights</span><span class="p">(</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">init_input_shape</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">:</span>
            <span class="n">params__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to_bf16</span><span class="p">(</span><span class="n">params__</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span><span class="p">:</span>
            <span class="n">params__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">(</span><span class="n">params__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">freeze</span><span class="p">({</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params__</span><span class="p">}),</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__call__</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_train_state_from_params</span><span class="p">(</span><span class="n">params_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params_</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">loss_remat</span> <span class="o">==</span> <span class="s1">&#39;OHA&#39;</span><span class="p">:</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">fjformer</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">loss_func</span><span class="o">.</span><span class="n">cross_entropy_with_logits</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">loss_remat</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">fused_cross_entropy_loss_and_accuracy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">cross_entropy_loss_and_accuracy</span>

    <span class="k">def</span> <span class="nf">fsdp_train_step_</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">with_sharding_constraint</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">step_partition_spec</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">batch</span><span class="p">,</span>
                                    <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span>
                <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span>

        <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">calculate_loss</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span><span class="p">),</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="o">=</span><span class="n">grad</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span>

    <span class="n">train_state_shape</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">eval_shape</span><span class="p">(</span><span class="n">init_fn</span><span class="p">)</span>
    <span class="n">train_state_partition_spec</span> <span class="o">=</span> <span class="n">match_partition_rules</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_partition_rules</span><span class="p">(</span>
            <span class="n">fully_fsdp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">fully_fsdp</span>
        <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">custom_rule</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">custom_rule</span><span class="p">,</span>
        <span class="n">train_state_shape</span>
    <span class="p">)</span>
    <span class="n">sharded_create_from_params_fn</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
        <span class="n">create_train_state_from_params</span><span class="p">,</span>
        <span class="n">in_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="o">.</span><span class="n">params</span><span class="p">,),</span>
        <span class="n">out_shardings</span><span class="o">=</span><span class="n">train_state_partition_spec</span><span class="p">,</span>
        <span class="n">donate_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
    <span class="p">)</span>
    <span class="n">sharded_train_step_fn</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
        <span class="n">fsdp_train_step_</span><span class="p">,</span>
        <span class="n">in_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">()),</span>
        <span class="n">out_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">(),</span> <span class="n">PartitionSpec</span><span class="p">()),</span>
        <span class="n">donate_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sharded_predict</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="n">out_shardings</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(),</span>
                           <span class="n">in_shardings</span><span class="o">=</span><span class="p">(</span><span class="n">train_state_partition_spec</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">()))</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_mesh</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">ckpt_path_exists</span><span class="p">()</span>
    <span class="n">ckpt_streamer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_streaming_checkpointer</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_state_partition_spec</span> <span class="o">=</span> <span class="n">train_state_partition_spec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_state_shape</span> <span class="o">=</span> <span class="n">train_state_shape</span>
    <span class="k">return</span> <span class="n">sharded_create_from_params_fn</span><span class="p">,</span> <span class="n">sharded_train_step_fn</span><span class="p">,</span> <span class="n">sharded_predict</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ckpt_streamer</span><span class="p">,</span> <span class="n">init_fn</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.configure_model" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">configure_model</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The configure_model function is responsible for creating the model, optimizer and scheduler.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Represent the instance of the class</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A model, optimizer, scheduler and config</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">configure_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The configure_model function is responsible for creating the model, optimizer and scheduler.</span>

<span class="sd">    :param self: Represent the instance of the class</span>
<span class="sd">    :return: A model, optimizer, scheduler and config</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extra_configs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">extra_configs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">extra_configs</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span>
                                            <span class="p">,</span> <span class="n">gradient_checkpointing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">gradient_checkpointing</span><span class="p">,</span>
                                            <span class="n">use_pjit_attention_force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_pjit_attention_force</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">extra_configs</span>
                                            <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;get_partition_rules&#39;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">FlaxAutoModelForCausalLM</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                     <span class="n">param_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">param_dtype</span><span class="p">,</span>
                                                     <span class="n">_do_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">],</span> <span class="s1">&#39;get_partition_rules&#39;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">custom_rule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;if you are using custom model to init you must&#39;</span> \
                                                           <span class="s1">&#39; pass custom_rule for partition rules &#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span>
            <span class="s1">&#39;config&#39;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">use_pjit_attention_force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_pjit_attention_force</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">sharding_array</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_class</span><span class="p">(</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">,</span>
            <span class="n">_do_init</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">configs_to_init_model_class</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>

    <span class="n">tx</span><span class="p">,</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_optimizer_and_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.finish" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">finish</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>The finish function is called when the experiment ends.
It can be used to save data, upload files, or do any other cleanup tasks.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary of the run's metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">finish</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The finish function is called when the experiment ends.</span>
<span class="sd">    It can be used to save data, upload files, or do any other cleanup tasks.</span>

<span class="sd">    :return: A dictionary of the run&#39;s metadata</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.init_functions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">init_functions</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The init_functions function is responsible for initializing the following:
    - wandb_runtime (if you use_wandb is True)
    - timer object (for logging time taken by various functions)
    - dataloader objects for training and evaluation data, along with max steps per epoch.
      The configure_dataloader function accomplishes this task.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Represent the instance of the class</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of functions</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">init_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The init_functions function is responsible for initializing the following:</span>
<span class="sd">        - wandb_runtime (if you use_wandb is True)</span>
<span class="sd">        - timer object (for logging time taken by various functions)</span>
<span class="sd">        - dataloader objects for training and evaluation data, along with max steps per epoch.</span>
<span class="sd">          The configure_dataloader function accomplishes this task.</span>

<span class="sd">    :param self: Represent the instance of the class</span>
<span class="sd">    :return: A tuple of functions</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_wandb_init</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">Timers</span><span class="p">(</span>
        <span class="n">use_wandb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">tensorboard_writer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_board</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
        <span class="s1">&#39;configure dataloaders&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">,</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_eval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_dataloader</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
        <span class="s1">&#39;configure dataloaders&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="s1">&#39;configure dataloaders&#39;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
        <span class="s1">&#39;configure Model ,Optimizer ,Scheduler and Config&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_model</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
        <span class="s1">&#39;configure Model ,Optimizer ,Scheduler and Config&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="s1">&#39;configure Model ,Optimizer ,Scheduler and Config&#39;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
        <span class="s1">&#39;configure functions and sharding them&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_functions</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sharded_create_from_params_fn</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sharded_train_step_fn</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sharded_predict</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_fn</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
        <span class="s1">&#39;configure functions and sharding them&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="s1">&#39;configure functions and sharding them&#39;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="lib.python.EasyDel.trainer.fsdp_train.CausalLMTrainer.train" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">model_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The train function is the main function of this module.
It takes a model_parameters argument which can be used to load a pretrained model and finetune it.
The train function returns an OutputFineTuner object that contains the last saved file name, predict func,
train state, mesh and checkpoint streamer.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Make the class methods aware of other methods and attributes within the class</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_parameters</code></td>
          <td>
                <code><span title="flax.core.FrozenDict">FrozenDict</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>flax.core.FrozenDict: Load a pre-trained model</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="lib.python.EasyDel.trainer.fsdp_train.OutputFineTuner">OutputFineTuner</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An object of type "OutputFineTuner"</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_parameters</span><span class="p">:</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FrozenDict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputFineTuner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The train function is the main function of this module.</span>
<span class="sd">    It takes a model_parameters argument which can be used to load a pretrained model and finetune it.</span>
<span class="sd">    The train function returns an OutputFineTuner object that contains the last saved file name, predict func,</span>
<span class="sd">    train state, mesh and checkpoint streamer.</span>


<span class="sd">    :param self: Make the class methods aware of other methods and attributes within the class</span>
<span class="sd">    :param model_parameters: flax.core.FrozenDict: Load a pre-trained model</span>
<span class="sd">    :return: An object of type &quot;OutputFineTuner&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">count_params</span><span class="p">(</span><span class="n">_p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31mModel Contain : &#39;</span><span class="p">,</span>
              <span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_flatten</span><span class="p">(</span><span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">_p</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
              <span class="s1">&#39; Billion Parameters&#39;</span><span class="p">)</span>

    <span class="n">dir_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;/dev/shm&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">track_memory</span><span class="p">:</span>
        <span class="n">initialise_tracking</span><span class="p">(</span><span class="n">dir_prefix</span><span class="o">=</span><span class="n">dir_prefix</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finetune</span><span class="p">:</span>
            <span class="n">shard_fns</span><span class="p">,</span> <span class="n">gather_fns</span> <span class="o">=</span> <span class="n">make_shard_and_gather_fns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_state_partition_spec</span><span class="p">,</span>
                                                              <span class="n">dtype_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prefix_print</span><span class="p">(</span>
                    <span class="s1">&#39;Action&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Loading Model From </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">StreamingCheckpointer</span><span class="o">.</span><span class="n">load_trainstate_checkpoint</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;params::</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_state_shape</span><span class="p">,</span> <span class="n">shard_fns</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">remove_ckpt_after_load</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prefix_print</span><span class="p">(</span>
                    <span class="s1">&#39;Action&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Sharding Passed Parameters&#39;</span>
                <span class="p">)</span>
                <span class="kn">from</span> <span class="nn">flax.core</span> <span class="kn">import</span> <span class="n">unfreeze</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_parameters</span><span class="p">,</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FrozenDict</span><span class="p">):</span>
                    <span class="n">prefix_print</span><span class="p">(</span>
                        <span class="s1">&#39;Warning&#39;</span><span class="p">,</span> <span class="s1">&#39;Model Parameters should be like FrozenDict({&quot;params&quot; : params}) make sure to &#39;</span>
                                   <span class="s1">&#39;pass as type FrozenDict in case of not getting UnExcepted Errors &#39;</span>
                    <span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">model_parameters</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_shard_fns</span> <span class="k">else</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shard_fns</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                    <span class="n">model_parameters</span><span class="p">)</span>

            <span class="n">sharded_train_state_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharded_create_from_params_fn</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

            <span class="n">count_params</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sharded_train_state_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_fn</span><span class="p">()</span>

            <span class="n">count_params</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">learning_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;model billion parameters&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="n">i</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                        <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_flatten</span><span class="p">(</span><span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e9</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader_train</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps_train</span><span class="p">:</span>

                        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>

                        <span class="k">for</span> <span class="n">ssb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">ids_to_pop_from_dataset</span><span class="p">:</span>
                            <span class="n">_</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ssb</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">time_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">sharded_train_state_</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharded_train_step_fn</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="p">,</span>
                                                                                          <span class="n">batch</span>
                                                                                          <span class="p">)</span>
                        <span class="n">ttl_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_s</span>
                        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                        <span class="n">learning_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">track_memory</span><span class="p">:</span>
                            <span class="n">mem_res</span> <span class="o">=</span> <span class="n">get_mem</span><span class="p">(</span><span class="n">dir_prefix</span><span class="o">=</span><span class="n">dir_prefix</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mem_res</span> <span class="o">=</span> <span class="s1">&#39;Tracking Option is OFF&#39;</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">jax</span><span class="o">.</span><span class="n">spmd_mode</span><span class="p">(</span><span class="s2">&quot;allow_all&quot;</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span>
                                            <span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                        <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                        <span class="s2">&quot;step time&quot;</span><span class="p">:</span> <span class="n">ttl_time</span><span class="p">,</span>
                                        <span class="s2">&quot;perplexity&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                        <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                        <span class="s2">&quot;avg_accuracy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">accuracies</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accuracies</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                        <span class="s2">&quot;mem_res&quot;</span><span class="p">:</span> <span class="n">mem_res</span><span class="p">,</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">track_memory</span><span class="p">:</span>
                            <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">mem_res</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                         <span class="n">step</span><span class="o">=</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                         <span class="n">perplexity</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                         <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span>
                                         <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">save_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Model to </span><span class="se">\033</span><span class="s1">[1;30m</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\033</span><span class="s1">[1;0m&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
                                                           <span class="n">filename</span><span class="p">,</span>
                                                           <span class="n">gather_fns</span><span class="o">=</span><span class="n">gather_fns</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;30m KeyboardInterrupt At training model Will return current state of the model * </span><span class="se">\033</span><span class="s1">[1;0m&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_eval</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_eval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pbar_eval</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_steps_eval</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i_eval</span><span class="p">,</span> <span class="n">batch_eval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader_eval</span><span class="p">):</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">batch_eval</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;token_type_ids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">batch_eval</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_eval</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">ids_to_pop_from_dataset</span><span class="p">:</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">batch_eval</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">loss_eval</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">create_fsdp_eval_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">step_partition_spec</span><span class="p">)(</span>
                        <span class="n">sharded_train_state_</span><span class="p">,</span> <span class="n">batch_eval</span><span class="p">)</span>
                    <span class="n">pbar_eval</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">use_wandb</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">wandb_runtime</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;loss_eval&#39;</span><span class="p">:</span> <span class="n">loss_eval</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                             <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
                        <span class="p">)</span>
                    <span class="n">pbar_eval</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss_eval</span><span class="o">=</span><span class="n">loss_eval</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">save_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">do_last_save</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Model to </span><span class="se">\033</span><span class="s1">[1;30m</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\033</span><span class="s1">[1;0m&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">sharded_train_state_</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
                                               <span class="n">filename</span><span class="p">,</span>
                                               <span class="n">gather_fns</span><span class="o">=</span><span class="n">gather_fns</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;not_saved | None&#39;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">OutputFineTuner</span><span class="p">(</span>
        <span class="n">last_save_file_name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">predict_fun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sharded_predict</span><span class="p">,</span>
        <span class="n">train_state</span><span class="o">=</span><span class="n">sharded_train_state_</span><span class="p">,</span>
        <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
        <span class="n">shard_fns</span><span class="o">=</span><span class="n">shard_fns</span><span class="p">,</span>
        <span class="n">gather_fns</span><span class="o">=</span><span class="n">gather_fns</span><span class="p">,</span>
        <span class="n">ckpt_stream</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_streamer</span>
    <span class="p">)</span>
    <span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>



<div class="doc doc-object doc-function">




<h2 id="lib.python.EasyDel.trainer.fsdp_train.calculate_accuracy" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">calculate_accuracy</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The calculate_accuracy function takes in two arrays, predictions and targets.
The function then calculates the accuracy of the model by comparing the predicted classes to
the target classes. The predicted class is determined by taking argmax along axis - 1 of predictions.
The correct_predictions variable is an array containing True or False values depending on whether or not
the prediction was correct for each example in a batch. The total number of examples that were correctly
predicted are summed up and divided by the total number of examples to get an accuracy value between 0 and 1.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>predictions</code></td>
          <td>
                <code><span title="chex.Array">Array</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>chex.Array: Pass in the predictions from the model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>targets</code></td>
          <td>
                <code><span title="chex.Array">Array</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>chex.Array: Calculate the accuracy of the model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A single value, the accuracy</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_accuracy</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The calculate_accuracy function takes in two arrays, predictions and targets.</span>
<span class="sd">    The function then calculates the accuracy of the model by comparing the predicted classes to</span>
<span class="sd">    the target classes. The predicted class is determined by taking argmax along axis - 1 of predictions.</span>
<span class="sd">    The correct_predictions variable is an array containing True or False values depending on whether or not</span>
<span class="sd">    the prediction was correct for each example in a batch. The total number of examples that were correctly</span>
<span class="sd">    predicted are summed up and divided by the total number of examples to get an accuracy value between 0 and 1.</span>

<span class="sd">    :param predictions: chex.Array: Pass in the predictions from the model</span>
<span class="sd">    :param targets: chex.Array: Calculate the accuracy of the model</span>
<span class="sd">    :return: A single value, the accuracy</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">predicted_classes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">correct_predictions</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicted_classes</span> <span class="o">==</span> <span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_predictions</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct_predictions</span> <span class="o">/</span> <span class="n">total_predictions</span>
    <span class="k">return</span> <span class="n">accuracy</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="lib.python.EasyDel.trainer.fsdp_train.create_fsdp_eval_step" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_fsdp_eval_step</span><span class="p">(</span><span class="n">partition_spec</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">((</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;fsdp&#39;</span><span class="p">),</span> <span class="s1">&#39;mp&#39;</span><span class="p">))</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The create_fsdp_eval_step function is used to create a function that calculates the loss and accuracy of a model.
It takes in a set of parameters, which are then passed into the state.apply_fn function
to generate logits for each token in the batch. The cross entropy loss and accuracy are then calculated from these logits.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>partition_spec</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the partitioning of the model parameters</p>
            </div>
          </td>
          <td>
                <code><span title="jax.sharding.PartitionSpec">PartitionSpec</span>((&#39;dp&#39;, &#39;fsdp&#39;), &#39;mp&#39;)</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A function that can be used to calculate the loss and accuracy of a model</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_fsdp_eval_step</span><span class="p">(</span><span class="n">partition_spec</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">((</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;fsdp&#39;</span><span class="p">),</span> <span class="s1">&#39;mp&#39;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The create_fsdp_eval_step function is used to create a function that calculates the loss and accuracy of a model.</span>
<span class="sd">    It takes in a set of parameters, which are then passed into the state.apply_fn function</span>
<span class="sd">    to generate logits for each token in the batch. The cross entropy loss and accuracy are then calculated from these logits.</span>

<span class="sd">    :param partition_spec: Specify the partitioning of the model parameters</span>
<span class="sd">    :return: A function that can be used to calculate the loss and accuracy of a model</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fsdp_eval_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">batch_eval</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The fsdp_eval_step function is used to calculate the loss and accuracy of a model.</span>
<span class="sd">        It takes in a set of parameters, which are then passed into the state.apply_fn function</span>
<span class="sd">        to generate logits for each token in the batch. The cross entropy loss and accuracy are then calculated from these logits.</span>

<span class="sd">        :param state: Store the model parameters and other information about the training process</span>
<span class="sd">        :param batch_eval: Pass the batch of data to the function</span>
<span class="sd">        :return: The loss and accuracy of the model</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_eval</span> <span class="o">=</span> <span class="n">with_sharding_constraint</span><span class="p">(</span>
            <span class="n">batch_eval</span><span class="p">,</span> <span class="n">partition_spec</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The calculate_loss function is used to calculate the loss and accuracy of a model.</span>
<span class="sd">            It takes in a set of parameters, which are then passed into the state.apply_fn function</span>
<span class="sd">            to generate logits for each token in the batch. The cross entropy loss and accuracy are then calculated from these logits.</span>

<span class="sd">            :param params: Pass the model parameters to the function</span>
<span class="sd">            :return: The loss and the accuracy</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch_eval</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">batch_eval</span><span class="p">,</span>
                                    <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>

            <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">cross_entropy_loss_and_accuracy</span><span class="p">(</span>
                <span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch_eval</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span>

        <span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span> <span class="o">=</span> <span class="n">calculate_loss</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span>

    <span class="k">return</span> <span class="n">fsdp_eval_step</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="lib.python.EasyDel.trainer.fsdp_train.create_fsdp_train_step" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_fsdp_train_step</span><span class="p">(</span><span class="n">partition_spec</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">((</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;fsdp&#39;</span><span class="p">),</span> <span class="s1">&#39;mp&#39;</span><span class="p">))</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The create_fsdp_train_step function is a training step function that takes in the current state of the model,
and a batch of data. It then calculates the loss and accuracy for this batch, and returns an updated state
with new parameters based on these gradients.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>partition_spec</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify which devices the model will be split across</p>
            </div>
          </td>
          <td>
                <code><span title="jax.sharding.PartitionSpec">PartitionSpec</span>((&#39;dp&#39;, &#39;fsdp&#39;), &#39;mp&#39;)</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A fsdp_train_step function that takes in the current state of the model,</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_fsdp_train_step</span><span class="p">(</span><span class="n">partition_spec</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">((</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;fsdp&#39;</span><span class="p">),</span> <span class="s1">&#39;mp&#39;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The create_fsdp_train_step function is a training step function that takes in the current state of the model,</span>
<span class="sd">    and a batch of data. It then calculates the loss and accuracy for this batch, and returns an updated state</span>
<span class="sd">    with new parameters based on these gradients.</span>

<span class="sd">    :param partition_spec: Specify which devices the model will be split across</span>
<span class="sd">    :return: A fsdp_train_step function that takes in the current state of the model,</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fsdp_train_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The fsdp_train_step function is a training step function that takes in the current state of the model,</span>
<span class="sd">        and a batch of data. It then calculates the loss and accuracy for this batch, and returns an updated state</span>
<span class="sd">        with new parameters based on these gradients.</span>

<span class="sd">        :param state: Store the model parameters</span>
<span class="sd">        :param batch: Pass the data to the model</span>
<span class="sd">        :return: A tuple of (state, loss, accuracy)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">with_sharding_constraint</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">partition_spec</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">batch</span><span class="p">,</span>
                                    <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>

            <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">cross_entropy_loss_and_accuracy</span><span class="p">(</span>
                <span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span>

        <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">calculate_loss</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span><span class="p">),</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="o">=</span><span class="n">grad</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">loss__</span><span class="p">,</span> <span class="n">accuracy__</span>

    <span class="k">return</span> <span class="n">fsdp_train_step</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="lib.python.EasyDel.trainer.fsdp_train.predict" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The predict function takes in a state and input_ids, and returns the next token.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>state</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Store the model parameters and the input_ids parameter is used to pass in a batch of token ids</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>input_ids</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Pass the input to the model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The next input_ids</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/trainer/fsdp_train.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The predict function takes in a state and input_ids, and returns the next token.</span>

<span class="sd">    :param state: Store the model parameters and the input_ids parameter is used to pass in a batch of token ids</span>
<span class="sd">    :param input_ids: Pass the input to the model</span>
<span class="sd">    :return: The next input_ids</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">with_sharding_constraint</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">((</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;fsdp&#39;</span><span class="p">)))</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">logits</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">input_ids</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Erfan Zare Chavoshi-EasyDel
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
    
  </body>
</html>